<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zing Coin - Login</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #050505; color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .header { text-align: center; margin-top: 20px; }
        .header h1 { font-size: 28px; font-weight: 800; color: #00d2ff; }
        
        .avatar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0; width: 100%; max-width: 320px; }
        .avatar-card { aspect-ratio: 1/1; background: #111; border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 3px solid #222; cursor: pointer; }
        .avatar-card.selected { border-color: #00d2ff; background: rgba(0, 210, 255, 0.1); }
        .avatar-card i { font-size: 30px; pointer-events: none; }

        .input-box { width: 100%; max-width: 320px; padding: 15px; background: #151515; border: 2px solid #222; border-radius: 12px; color: white; font-size: 16px; margin-bottom: 10px; outline: none; }
        .rules { width: 100%; max-width: 320px; font-size: 11px; margin-bottom: 20px; }
        .rule { color: #555; margin-bottom: 4px; }
        .rule.valid { color: #2ed573; }

        .btn-main { width: 100%; max-width: 320px; padding: 18px; border-radius: 12px; border: none; font-weight: 800; text-transform: uppercase; background: #222; color: #555; transition: 0.3s; }
        .btn-main.enabled { background: linear-gradient(90deg, #00d2ff, #3a7bd5); color: white; cursor: pointer; }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:#050505; display:flex; justify-content:center; align-items:center; z-index:9999; }
    </style>
</head>
<body>

    <div id="loader">
        <p>Checking Account...</p>
    </div>

    <div class="header">
        <h1>ZING PROFILE</h1>
        <p>Set up your account to start earning</p>
    </div>

    <div class="avatar-grid">
        <div class="avatar-card" onclick="setAvatar(this, 'fa-dragon', '#ff4757')"><i class="fas fa-dragon" style="color:#ff4757"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-robot', '#2ed573')"><i class="fas fa-robot" style="color:#2ed573"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-ghost', '#1e90ff')"><i class="fas fa-ghost" style="color:#1e90ff"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-user-ninja', '#ffa502')"><i class="fas fa-user-ninja" style="color:#ffa502"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-user-astronaut', '#eccc68')"><i class="fas fa-user-astronaut" style="color:#eccc68"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-skull', '#70a1ff')"><i class="fas fa-skull" style="color:#70a1ff"></i></div>
    </div>

    <input type="text" id="usernameInput" class="input-box" placeholder="Username (e.g. Player01)" oninput="validate()">
    
    <div class="rules">
        <div id="r1" class="rule">• Select an Avatar</div>
        <div id="r2" class="rule">• No spaces allowed</div>
        <div id="r3" class="rule">• Must include a number</div>
    </div>

    <button id="regBtn" class="btn-main" onclick="registerUser()" disabled>Login and Earn</button>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. TELEGRAM INITIALIZE ---
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let selectedAvatar = null;
        let selectedColor = null;

        // --- 3. AUTO LOGIN LOGIC ---
        window.onload = async function() {
            const tgUser = tg.initDataUnsafe?.user;
            
            // local storage එකේ තියෙනවද බලන්න
            const localUser = localStorage.getItem('zingUser');
            if(localUser) {
                window.location.href = "home.html";
                return;
            }

            // Firebase එකේ telegramId එකෙන් ඉන්නවද බලන්න
            if(tgUser) {
                const snapshot = await db.ref('users').orderByChild('telegramId').equalTo(tgUser.id).once('value');
                if(snapshot.exists()){
                    const users = snapshot.val();
                    const key = Object.keys(users)[0];
                    localStorage.setItem('zingUser', JSON.stringify(users[key]));
                    window.location.href = "home.html";
                    return;
                }
                // යූසර්ගේ නම කලින්ම පුරවන්න
                document.getElementById('usernameInput').value = tgUser.username || tgUser.first_name || "";
                validate();
            }
            // Loader එක අයින් කරනවා
            document.getElementById('loader').style.display = 'none';
        }

        function setAvatar(el, icon, color) {
            document.querySelectorAll('.avatar-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedAvatar = icon;
            selectedColor = color;
            validate();
        }

        function validate() {
            const val = document.getElementById('usernameInput').value.trim();
            const isAvatar = selectedAvatar !== null;
            const noSpace = val.length > 0 && !/\s/.test(val);
            const hasNum = /\d/.test(val);

            document.getElementById('r1').className = isAvatar ? 'rule valid' : 'rule';
            document.getElementById('r2').className = noSpace ? 'rule valid' : 'rule';
            document.getElementById('r3').className = hasNum ? 'rule valid' : 'rule';

            const btn = document.getElementById('regBtn');
            if(isAvatar && noSpace && hasNum) {
                btn.classList.add('enabled');
                btn.disabled = false;
            } else {
                btn.classList.remove('enabled');
                btn.disabled = true;
            }
        }

        async function registerUser() {
            const name = document.getElementById('usernameInput').value.trim();
            const tgUser = tg.initDataUnsafe?.user;

            try {
                // නම පාවිච්චි කරලා තියෙනවද බලන්න
                const snap = await db.ref('users').orderByChild('username').equalTo(name).once('value');
                if(snap.exists()) return alert("Username already taken!");

                const countSnap = await db.ref('userCount').once('value');
                let count = countSnap.val() || 0;
                let newId = (count + 1).toString().padStart(2, '0');

                const userData = {
                    id: newId,
                    username: name,
                    avatar: selectedAvatar,
                    color: selectedColor,
                    coins: 0,
                    telegramId: tgUser ? tgUser.id : "N/A"
                };
                
                await db.ref('users/' + newId).set(userData);
                await db.ref('userCount').set(count + 1);

                localStorage.setItem('zingUser', JSON.stringify(userData));
                window.location.href = "home.html";
            } catch(e) {
                alert("Error: " + e.message);
            }
        }
    </script>
</body>
</html>
