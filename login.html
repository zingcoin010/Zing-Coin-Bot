<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zing Coin - Login</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #050505; color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .header { text-align: center; margin-top: 20px; }
        .header h1 { font-size: 28px; font-weight: 800; color: #00d2ff; }
        .header p { font-size: 12px; color: #777; margin-top: 5px; }

        /* Avatar Selection Box */
        .avatar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0; width: 100%; max-width: 320px; }
        .avatar-card { 
            aspect-ratio: 1/1; 
            background: #111; 
            border-radius: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 3px solid #222; 
            cursor: pointer; 
            transition: 0.3s; 
        }
        .avatar-card i { font-size: 30px; pointer-events: none; }
        /* Selected State */
        .avatar-card.selected { 
            border-color: #00d2ff !important; 
            background: rgba(0, 210, 255, 0.1); 
            transform: scale(1.05); 
        }

        .input-box { width: 100%; max-width: 320px; padding: 15px; background: #151515; border: 2px solid #222; border-radius: 12px; color: white; font-size: 16px; margin-bottom: 10px; outline: none; }
        .input-box:focus { border-color: #333; }

        .rules { width: 100%; max-width: 320px; font-size: 11px; margin-bottom: 20px; background: rgba(255,255,255,0.02); padding: 15px; border-radius: 12px; }
        .rule { color: #555; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .rule i { font-size: 8px; }
        .rule.valid { color: #2ed573; }

        .btn-main { 
            width: 100%; 
            max-width: 320px; 
            padding: 18px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 800; 
            text-transform: uppercase; 
            cursor: not-allowed; 
            background: #222; 
            color: #555; 
            transition: 0.3s; 
        }
        .btn-main.enabled { 
            background: linear-gradient(90deg, #00d2ff, #3a7bd5); 
            color: white; 
            cursor: pointer; 
            box-shadow: 0 8px 20px rgba(0, 210, 255, 0.3); 
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>ZING PROFILE</h1>
        <p>Set up your account to start earning</p>
    </div>

    <div class="avatar-grid" id="avatarGrid">
        <div class="avatar-card" onclick="setAvatar(this, 'fa-dragon', '#ff4757')"><i class="fas fa-dragon" style="color:#ff4757"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-robot', '#2ed573')"><i class="fas fa-robot" style="color:#2ed573"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-ghost', '#1e90ff')"><i class="fas fa-ghost" style="color:#1e90ff"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-user-ninja', '#ffa502')"><i class="fas fa-user-ninja" style="color:#ffa502"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-user-astronaut', '#eccc68')"><i class="fas fa-user-astronaut" style="color:#eccc68"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-skull', '#70a1ff')"><i class="fas fa-skull" style="color:#70a1ff"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-bolt', '#ff6b81')"><i class="fas fa-bolt" style="color:#ff6b81"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-crown', '#7bed9f')"><i class="fas fa-crown" style="color:#7bed9f"></i></div>
        <div class="avatar-card" onclick="setAvatar(this, 'fa-gamepad', '#ffffff')"><i class="fas fa-gamepad" style="color:#ffffff"></i></div>
    </div>

    <input type="text" id="usernameInput" class="input-box" placeholder="Username (e.g. Alex_77)" oninput="validate()">
    
    <div class="rules">
        <div id="r1" class="rule"><i class="fas fa-circle"></i> Select an Avatar</div>
        <div id="r2" class="rule"><i class="fas fa-circle"></i> No spaces allowed</div>
        <div id="r3" class="rule"><i class="fas fa-circle"></i> Must include a number</div>
    </div>

    <button id="regBtn" class="btn-main" onclick="registerUser()" disabled>Login and Earn</button>

    <script>
        // --- 1. YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyA5A8qm5QIvqVaGbuz8j8w-ZJ3W0p96qpQ",
            databaseURL: "https://zing-coin-default-rtdb.firebaseio.com",
            projectId: "zing-coin",
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. TELEGRAM SETTINGS ---
        const tg = window.Telegram.WebApp;
        tg.expand();

        let selectedAvatar = null;
        let selectedColor = null;

        // Auto-fill from Telegram if available
        window.onload = () => {
            const user = tg.initDataUnsafe?.user;
            if (user) {
                document.getElementById('usernameInput').value = user.username || user.first_name || "";
                validate();
            }
        };

        // --- 3. FUNCTIONS ---
        function setAvatar(el, icon, color) {
            // Remove selection from all
            document.querySelectorAll('.avatar-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked
            el.classList.add('selected');
            
            selectedAvatar = icon;
            selectedColor = color;
            validate();
        }

        function validate() {
            const username = document.getElementById('usernameInput').value.trim();
            const isAvatarSelected = selectedAvatar !== null;
            const hasNoSpaces = username.length > 0 && !/\s/.test(username);
            const hasNumber = /\d/.test(username);

            // Update UI Rules
            document.getElementById('r1').className = isAvatarSelected ? 'rule valid' : 'rule';
            document.getElementById('r2').className = hasNoSpaces ? 'rule valid' : 'rule';
            document.getElementById('r3').className = hasNumber ? 'rule valid' : 'rule';

            const btn = document.getElementById('regBtn');
            if(isAvatarSelected && hasNoSpaces && hasNumber) {
                btn.disabled = false;
                btn.classList.add('enabled');
            } else {
                btn.disabled = true;
                btn.classList.remove('enabled');
            }
        }

        async function registerUser() {
            const username = document.getElementById('usernameInput').value.trim();
            const btn = document.getElementById('regBtn');
            btn.innerText = "Please wait...";
            btn.disabled = true;

            try {
                // Check if username already exists
                const snapshot = await db.ref('users').orderByChild('username').equalTo(username).once('value');
                if (snapshot.exists()) {
                    alert("This username is already taken. Try another!");
                    btn.innerText = "Login and Earn";
                    btn.disabled = false;
                    return;
                }

                // Get User Count for ID
                const countSnap = await db.ref('userCount').once('value');
                let currentCount = countSnap.val() || 0;
                let newId = (currentCount + 1).toString().padStart(2, '0');

                const userData = {
                    id: newId,
                    username: username,
                    avatar: selectedAvatar,
                    color: selectedColor,
                    coins: 0,
                    tgId: tg.initDataUnsafe?.user?.id || "web-user"
                };

                // Save to Firebase
                await db.ref('users/' + newId).set(userData);
                await db.ref('userCount').set(currentCount + 1);

                // Save locally
                localStorage.setItem('zingUser', JSON.stringify(userData));
                
                // Redirect
                window.location.href = "home.html";

            } catch (error) {
                alert("Firebase Error: " + error.message);
                btn.innerText = "Login and Earn";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
